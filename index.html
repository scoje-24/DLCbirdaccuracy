<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Point Labeler</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { border: 2px solid #333; cursor: crosshair; margin-top: 10px; max-width: 95%; height: auto; }
    #controls { margin: 15px; }
    #labelInfo { font-size: 18px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Click to label points</h2>

  <label>Your ID:
    <input type="text" id="userId" placeholder="Enter name or ID">
  </label><br><br>

  <canvas id="canvas"></canvas>
  <div id="labelInfo"></div>

  <div id="controls">
    <button onclick="prevImage()">⬅ Prev Image</button>
    <button onclick="nextLabel()">➡ Next Label</button>
    <button onclick="nextImage()">Next Image ➡</button>
    <button onclick="downloadCSV()">⬇ Download CSV</button>
  </div>

  <script>
    // Labels + colors
    const labels = [
      "topBeaktip","botBeaktip","rightEye","rightHinge","leftEye","leftHinge"
    ];
    const colors = ["red","blue","green","magenta","orange","cyan"];

    // Images to annotate (stored inside "savannah_sparrow/")
    const images = [
      "savannah_sparrow/img0012.png", "savannah_sparrow/img0032.png", "savannah_sparrow/img0138.png",
      "savannah_sparrow/img0254.png", "savannah_sparrow/img0260.png", "savannah_sparrow/img0273.png",
      "savannah_sparrow/img0381.png", "savannah_sparrow/img0433.png", "savannah_sparrow/img0457.png",
      "savannah_sparrow/img0566.png", "savannah_sparrow/img0651.png", "savannah_sparrow/img0925.png",
      "savannah_sparrow/img1055.png", "savannah_sparrow/img1129.png", "savannah_sparrow/img1154.png",
      "savannah_sparrow/img1184.png", "savannah_sparrow/img1272.png", "savannah_sparrow/img1284.png",
      "savannah_sparrow/img1409.png", "savannah_sparrow/img1465.png", "savannah_sparrow/img1477.png",
      "savannah_sparrow/img1480.png", "savannah_sparrow/img1553.png", "savannah_sparrow/img1678.png",
      "savannah_sparrow/img1748.png", "savannah_sparrow/img1804.png", "savannah_sparrow/img1854.png",
      "savannah_sparrow/img2006.png", "savannah_sparrow/img2064.png", "savannah_sparrow/img2067.png",
      "savannah_sparrow/img2146.png", "savannah_sparrow/img2224.png", "savannah_sparrow/img2257.png",
      "savannah_sparrow/img2283.png", "savannah_sparrow/img2302.png", "savannah_sparrow/img2396.png",
      "savannah_sparrow/img2424.png", "savannah_sparrow/img2440.png", "savannah_sparrow/img2562.png",
      "savannah_sparrow/img2624.png", "savannah_sparrow/img2691.png", "savannah_sparrow/img2730.png",
      "savannah_sparrow/img2876.png", "savannah_sparrow/img2978.png", "savannah_sparrow/img3041.png",
      "savannah_sparrow/img3089.png", "savannah_sparrow/img3101.png", "savannah_sparrow/img3124.png",
      "savannah_sparrow/img3181.png", "savannah_sparrow/img3277.png", "savannah_sparrow/img3306.png",
      "savannah_sparrow/img3309.png", "savannah_sparrow/img3340.png", "savannah_sparrow/img3353.png",
      "savannah_sparrow/img3360.png", "savannah_sparrow/img3433.png", "savannah_sparrow/img3467.png",
      "savannah_sparrow/img3537.png", "savannah_sparrow/img3554.png", "savannah_sparrow/img3584.png",
      "savannah_sparrow/img3695.png", "savannah_sparrow/img3732.png", "savannah_sparrow/img3783.png",
      "savannah_sparrow/img3862.png", "savannah_sparrow/img3880.png", "savannah_sparrow/img3894.png",
      "savannah_sparrow/img3905.png", "savannah_sparrow/img3983.png", "savannah_sparrow/img3999.png",
      "savannah_sparrow/img4190.png", "savannah_sparrow/img4210.png", "savannah_sparrow/img4280.png",
      "savannah_sparrow/img4421.png", "savannah_sparrow/img4433.png", "savannah_sparrow/img4452.png",
      "savannah_sparrow/img4540.png", "savannah_sparrow/img4630.png", "savannah_sparrow/img4711.png",
      "savannah_sparrow/img4781.png", "savannah_sparrow/img4872.png", "savannah_sparrow/img4876.png",
      "savannah_sparrow/img4902.png", "savannah_sparrow/img4940.png", "savannah_sparrow/img4962.png",
      "savannah_sparrow/img4992.png", "savannah_sparrow/img5000.png", "savannah_sparrow/img5007.png",
      "savannah_sparrow/img5015.png", "savannah_sparrow/img5064.png", "savannah_sparrow/img5076.png",
      "savannah_sparrow/img5108.png", "savannah_sparrow/img5112.png", "savannah_sparrow/img5305.png",
      "savannah_sparrow/img5325.png", "savannah_sparrow/img5423.png", "savannah_sparrow/img5448.png",
      "savannah_sparrow/img5508.png"
    ];

    let currentImage = 0;
    let currentLabel = 0;
    let annotations = {}; // { imageName: {label: {x,y}} }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();

    function loadImage() {
      img.src = images[currentImage];
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img,0,0);
        redrawPoints();
      };
      document.getElementById("labelInfo").textContent =
        "Current Label: " + labels[currentLabel];
    }

    canvas.addEventListener("click",(e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if(!annotations[images[currentImage]]) {
        annotations[images[currentImage]] = {};
      }
      annotations[images[currentImage]][labels[currentLabel]] = {x,y};
      redrawPoints();
    });

    function redrawPoints() {
      ctx.drawImage(img,0,0);
      const points = annotations[images[currentImage]];
      if(points){
        Object.keys(points).forEach((label)=>{
          const p = points[label];
          ctx.fillStyle = colors[labels.indexOf(label)];
          ctx.beginPath();
          ctx.arc(p.x,p.y,6,0,2*Math.PI);
          ctx.fill();
          ctx.fillText(label,p.x+8,p.y-8);
        });
      }
    }

    function nextLabel() {
      currentLabel = (currentLabel+1)%labels.length;
      document.getElementById("labelInfo").textContent =
        "Current Label: " + labels[currentLabel];
    }
    function prevImage() {
      if(currentImage>0){ currentImage--; loadImage(); }
    }
    function nextImage() {
      if(currentImage<images.length-1){ currentImage++; }
      else { alert("You labeled all images! Now download CSV."); }
      loadImage();
    }

    function downloadCSV() {
      const user = document.getElementById("userId").value || "anonymous";
      let csv = "scorer,," + labels.join(",,") + "\n";
      csv += "coords,," + labels.map(()=> "x,y").join(",") + "\n";

      images.forEach(imgName=>{
        csv += "labeled-data,," + imgName + ",";
        const points = annotations[imgName] || {};
        labels.forEach(label=>{
          if(points[label]) {
            csv += points[label].x.toFixed(2)+","+points[label].y.toFixed(2)+",";
          } else {
            csv += "NaN,NaN,";
          }
        });
        csv += "\n";
      });

      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = user+"_annotations.csv";
      a.click();
    }

    loadImage();
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Point Labeler</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { 
      border: 2px solid #333; 
      cursor: crosshair; 
      margin-top: 10px; 
      max-width: 95%; 
      height: auto; 
    }
    #controls { margin: 15px; }
    #labelInfo { font-size: 18px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Click to label points</h2>

  <label>Your ID:
    <input type="text" id="userId" placeholder="Enter name or ID">
  </label><br><br>

  <canvas id="canvas"></canvas>
  <div id="labelInfo"></div>

  <div id="controls">
    <button onclick="prevImage()">⬅ Prev Image</button>
    <button onclick="nextLabel()">➡ Next Label</button>
    <button onclick="nextImage()">Next Image ➡</button>
    <button onclick="downloadCSV()">⬇ Download CSV</button>
  </div>

  <script>
    // Labels + colors
    const labels = [
      "topBeaktip","botBeaktip","rightEye","rightHinge","leftEye","leftHinge"
    ];
    const colors = ["red","blue","green","magenta","orange","cyan"];

    // Images to annotate (correct folder path, single array!)
    const images = [
      "img0012.png","img0032.png","img0138.png","img0254.png","img0260.png",
      "img0273.png","img0381.png","img0433.png","img0457.png","img0566.png",
      "img0651.png","img0925.png","img1055.png","img1129.png","img1154.png",
      "img1184.png","img1272.png","img1284.png","img1409.png","img1465.png",
      "img1477.png","img1480.png","img1553.png","img1678.png","img1748.png",
      "img1804.png","img1854.png","img2006.png","img2064.png","img2067.png",
      "img2146.png","img2224.png","img2257.png","img2283.png","img2302.png",
      "img2396.png","img2424.png","img2440.png","img2562.png","img2624.png",
      "img2691.png","img2730.png","img2876.png","img2978.png","img3041.png",
      "img3089.png","img3101.png","img3124.png","img3181.png","img3277.png",
      "img3306.png","img3309.png","img3340.png","img3353.png","img3360.png",
      "img3433.png","img3467.png","img3537.png","img3554.png","img3584.png",
      "img3695.png","img3732.png","img3783.png","img3862.png","img3880.png",
      "img3894.png","img3905.png","img3983.png","img3999.png","img4190.png",
      "img4210.png","img4280.png","img4421.png","img4433.png","img4452.png",
      "img4540.png","img4630.png","img4711.png","img4781.png","img4872.png",
      "img4876.png","img4902.png","img4940.png","img4962.png","img4992.png",
      "img5000.png","img5007.png","img5015.png","img5064.png","img5076.png",
      "img5108.png","img5112.png","img5305.png","img5325.png","img5423.png",
      "img5448.png","img5508.png"
    ].map(f => "savannah sparrow/" + f);  // prefix folder path

    let currentImage = 0;
    let currentLabel = 0;
    let annotations = {}; // { imageName: {label: {x,y}} }

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();

    function loadImage() {
      img.src = images[currentImage];
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img,0,0);
        redrawPoints();
      };
      document.getElementById("labelInfo").textContent =
        "Current Label: " + labels[currentLabel] +
        " | Image " + (currentImage+1) + " of " + images.length;
    }

    canvas.addEventListener("click",(e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if(!annotations[images[currentImage]]) {
        annotations[images[currentImage]] = {};
      }
      annotations[images[currentImage]][labels[currentLabel]] = {x,y};
      redrawPoints();
    });

    function redrawPoints() {
      ctx.drawImage(img,0,0);
      const points = annotations[images[currentImage]];
      if(points){
        Object.keys(points).forEach(label=>{
          const p = points[label];
          ctx.fillStyle = colors[labels.indexOf(label)];
          ctx.beginPath();
          ctx.arc(p.x,p.y,6,0,2*Math.PI);
          ctx.fill();
          ctx.fillText(label,p.x+8,p.y-8);
        });
      }
    }

    function nextLabel() {
      currentLabel = (currentLabel+1)%labels.length;
      document.getElementById("labelInfo").textContent =
        "Current Label: " + labels[currentLabel] +
        " | Image " + (currentImage+1) + " of " + images.length;
    }
    function prevImage() {
      if(currentImage>0){ currentImage--; loadImage(); }
    }
    function nextImage() {
      if(currentImage<images.length-1){ currentImage++; }
      else { alert("You labeled all images! Now download CSV."); }
      loadImage();
    }

    function downloadCSV() {
      const user = document.getElementById("userId").value || "anonymous";
      let csv = "scorer,," + labels.join(",,") + "\n";
      csv += "coords,," + labels.map(()=> "x,y").join(",") + "\n";

      images.forEach(imgName=>{
        csv += "labeled-data,," + imgName + ",";
        const points = annotations[imgName] || {};
        labels.forEach(label=>{
          if(points[label]) {
            csv += points[label].x.toFixed(2)+","+points[label].y.toFixed(2)+",";
          } else {
            csv += "NaN,NaN,";
          }
        });
        csv += "\n";
      });

      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = user+"_annotations.csv";
      a.click();
    }

    // Load the first image at start
    loadImage();
  </script>
</body>
</html>

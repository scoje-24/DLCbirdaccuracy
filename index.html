<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Point Labeler â€” Multi-Species Folders</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; text-align: center; margin: 8px; }
    #canvasWrap { display:inline-block; border:2px solid #333; padding:6px; background:#fafafa; max-width:95vw; }
    canvas { display:block; cursor:crosshair; max-width:100%; height:auto; }
    #controls { margin:12px 0; }
    #labelInfo { font-size:16px; font-weight:600; margin-top:8px; }
    #status { font-size:13px; color:#555; margin-top:6px; white-space:pre-wrap; text-align:left; max-width:95vw; margin:0 auto; }
    #instructions { 
      max-width: 800px; 
      margin: 20px auto; 
      text-align: left; 
      font-size: 15px; 
      line-height: 1.5; 
      background: #f9f9f9; 
      padding: 12px 16px; 
      border-radius: 8px; 
      border: 1px solid #ddd;
    }
    button, select { margin: 4px; padding:8px 12px; }
  </style>
</head>
<body>
  <h2>Point Labeler</h2>

  <!-- ðŸ”¹ Species Selector -->
  <div style="margin-bottom: 10px;">
    <label for="speciesSelect"><strong>Select Species:</strong></label>
    <select id="speciesSelect">
      <option value="Savannah Sparrow">Savannah Sparrow</option>
      <option value="Grasshopper Sparrow">Grasshopper Sparrow</option>
      <option value="American Redstart">American Redstart</option>
      <option value="Bachman's Sparrow">Bachman's Sparrow</option>
    </select>
  </div>

  <div id="canvasWrap">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <div id="labelInfo"></div>

  <div id="controls">
    <button onclick="prevImage()">â¬… Prev Image</button>
    <button onclick="prevLabel()">âŸ² Prev Label</button>
    <button onclick="nextLabel()">Next Label âŸ³</button>
    <button onclick="nextImage()">Next Image âž¡</button>
    <button onclick="clearCurrentLabel()">âœ– Clear All Labels (this image)</button>
    <button onclick="eraseCurrentPoint()">ðŸ©¹ Erase Current Point</button>
    <button onclick="downloadCSV()">â¬‡ Download CSV</button>
  </div>

  <div id="status">Status will appear here...</div>

  <!-- ðŸ”¹ Instructions -->
  <div id="instructions">
    <p><strong>Hello!</strong> Thank you for taking part in this project. Each species has its own folder and its own unique list of images. Please download your CSV before switching species to prevent data loss.</p>
  </div>

<script>
/* ---------- Config ---------- */
const labels = ["topBeaktip","botBeaktip","rightEye","rightHinge","leftEye","leftHinge"];
const colors = ["#e11","#1177ee","#129912","#c71585","#f39a1c","#00a5a5"];

// Folder paths and filenames per species
const speciesData = {
  "Savannah Sparrow": {
    folder: "savannah_sparrow",
    files: ["img0012.png","img0032.png","img0138.png","img0254.png","img0260.png","img0273.png","img0381.png","img0433.png", "img0457.png","img0566.png","img0651.png","img0925.png","img1055.png","img1129.png","img1154.png","img1184.png", "img1272.png","img1284.png","img1409.png","img1465.png","img1477.png","img1480.png","img1553.png","img1678.png", "img1748.png","img1804.png","img1854.png","img2006.png","img2064.png","img2067.png","img2146.png","img2224.png", "img2257.png","img2283.png","img2302.png","img2396.png","img2424.png","img2440.png","img2562.png","img2624.png", "img2691.png","img2730.png","img2876.png","img2978.png","img3041.png","img3089.png","img3101.png","img3124.png", "img3181.png","img3277.png","img3306.png","img3309.png","img3340.png","img3353.png","img3360.png","img3433.png", "img3467.png","img3537.png","img3554.png","img3584.png","img3695.png","img3732.png","img3783.png","img3862.png", "img3880.png","img3894.png","img3905.png","img3983.png","img3999.png","img4190.png","img4210.png","img4280.png", "img4421.png","img4433.png","img4452.png","img4540.png","img4630.png","img4711.png","img4781.png","img4872.png", "img4876.png","img4902.png","img4940.png","img4962.png","img4992.png","img5000.png","img5007.png","img5015.png", "img5064.png","img5076.png","img5108.png","img5112.png","img5305.png","img5325.png","img5423.png","img5448.png", "img5508.png"];
  },
  "Grasshopper Sparrow": {
    folder: "grasshopper_sparrow",
    files: ["img00159.png","img00232.png","img00455.png","img00907.png","img01359.png","img01408.png","img01461.png","img01478.png","img01685.png","img01795.png","img02142.png","img02236.png","img02482.png","img02562.png","img02891.png","img02969.png","img02996.png","img03284.png","img03375.png","img03583.png","img03609.png","img03770.png","img03998.png","img04323.png","img04740.png","img04845.png","img05138.png","img05439.png","img05906.png","img06163.png","img06233.png","img06358.png","img06361.png","img06403.png","img06596.png","img06806.png","img07154.png","img07314.png","img07771.png","img07878.png","img07888.png","img07915.png","img08243.png","img08370.png","img08382.png","img08678.png","img08745.png","img09261.png","img09265.png","img09605.png","img09617.png","img09786.png","img10023.png","img10152.png","img10326.png","img11130.png","img11134.png","img11375.png","img12254.png","img12677.png","img12966.png","img13697.png","img14167.png","img14212.png","img14364.png","img14592.png","img14836.png","img15204.png","img15290.png","img15736.png","img17219.png","img17348.png","img17479.png","img17737.png","img17809.png","img17977.png","img18052.png","img18308.png","img19211.png","img19340.png"]

  },
  "American Redstart": {
    folder: "american_redstart",
    files: ["img0001.png","img0041.png","img0192.png","img0241.png","img0248.png","img0371.png","img0406.png","img0465.png","img0466.png","img0492.png","img0498.png","img0499.png","img0512.png","img0638.png","img0647.png","img0747.png","img0767.png","img0821.png","img0822.png","img0850.png","img0892.png","img0901.png","img1060.png","img1174.png","img1292.png","img1319.png","img1357.png","img1374.png","img1386.png","img1447.png","img1453.png","img1696.png","img2027.png","img2042.png","img2166.png","img2181.png","img2283.png","img2305.png","img2340.png","img2350.png","img2405.png","img2481.png","img2486.png","img2509.png","img2660.png","img2737.png","img2791.png","img2890.png","img2962.png","img3005.png","img3012.png"]
  },
  "Bachman's Sparrow": {
    folder: "bachman_sparrow",
    files: ["img00001.png","img00159.png","img00348.png","img00508.png","img00690.png","img01140.png","img01270.png","img01407.png","img01478.png","img01746.png","img01907.png","img02031.png","img02317.png","img02426.png","img02582.png","img02689.png","img02792.png","img03158.png","img03502.png","img03553.png","img03599.png","img03760.png","img03830.png","img04046.png","img04524.png","img04848.png","img05218.png","img05506.png","img06009.png","img06245.png","img06262.png","img06749.png","img07104.png","img07874.png","img08356.png","img08652.png","img09423.png","img09475.png","img10075.png","img10623.png","img10763.png","img10845.png","img11169.png","img11371.png","img11390.png","img11417.png","img11856.png","img11885.png","img12090.png","img12137.png"]
  }
};

/* ---------- State ---------- */
let currentSpecies = "Savannah Sparrow";
let currentImageIndex = 0;
let currentLabelIndex = 0;
let annotationsBySpecies = {}; // Per-species storage
let annotations = {};
const randomID = Math.floor(1000000000 + Math.random() * 9000000000).toString();
let currentFiles = speciesData[currentSpecies].files;

// Elements
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const img = new Image();
const statusEl = document.getElementById("status");
const labelInfoEl = document.getElementById("labelInfo");
const speciesSelect = document.getElementById("speciesSelect");

/* ---------- Helpers ---------- */
function logStatus(txt){ console.log(txt); statusEl.textContent = txt; }
function setLabelInfo(){
  labelInfoEl.textContent = `Species: ${currentSpecies}  |  Label: ${labels[currentLabelIndex]}  |  Image ${currentImageIndex+1}/${currentFiles.length} (${currentFiles[currentImageIndex]})`;
}

/* ---------- Image loading ---------- */
function loadImage(){
  const folder = speciesData[currentSpecies].folder;
  const fname = currentFiles[currentImageIndex];
  const path = folder + fname;

  img.onload = () => {
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    ctx.drawImage(img,0,0);
    redrawPoints();
    setLabelInfo();
    logStatus(`Loaded: ${path}`);
  };
  img.onerror = () => {
    drawPlaceholder(`Missing: ${path}`);
    logStatus(`âš  Could not load ${path}`);
  };
  img.src = encodeURI(path);
}

function drawPlaceholder(text){
  const w=800,h=500;
  canvas.width=w; canvas.height=h;
  ctx.fillStyle="#eee"; ctx.fillRect(0,0,w,h);
  ctx.fillStyle="#333"; ctx.font="20px Arial"; ctx.fillText(text,20,40);
}

/* ---------- Canvas interaction ---------- */
function clientToImageCoords(x,y){
  const rect = canvas.getBoundingClientRect();
  return {
    x:(x-rect.left)*(canvas.width/rect.width),
    y:(y-rect.top)*(canvas.height/rect.height)
  };
}

canvas.addEventListener("click",(e)=>{
  if(!img.complete) return;
  const {x,y} = clientToImageCoords(e.clientX,e.clientY);
  const fname = currentFiles[currentImageIndex];
  if(!annotations[fname]) annotations[fname]={};
  annotations[fname][labels[currentLabelIndex]]={x:+x.toFixed(2),y:+y.toFixed(2)};
  redrawPoints();
});

/* ---------- Redraw ---------- */
function redrawPoints(){
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const fname = currentFiles[currentImageIndex];
  const pts = annotations[fname]||{};
  labels.forEach((lab,i)=>{
    if(pts[lab]){
      ctx.fillStyle=colors[i];
      ctx.beginPath(); ctx.arc(pts[lab].x,pts[lab].y,6,0,2*Math.PI); ctx.fill();
      ctx.fillText(lab,pts[lab].x+8,pts[lab].y-8);
    }
  });
}

/* ---------- Navigation ---------- */
function nextLabel(){ currentLabelIndex=(currentLabelIndex+1)%labels.length; setLabelInfo();}
function prevLabel(){ currentLabelIndex=(currentLabelIndex-1+labels.length)%labels.length; setLabelInfo();}
function nextImage(){ if(currentImageIndex<currentFiles.length-1){currentImageIndex++; loadImage();} }
function prevImage(){ if(currentImageIndex>0){currentImageIndex--; loadImage();} }

/* ---------- Erasers ---------- */
function eraseCurrentPoint(){
  const fname = currentFiles[currentImageIndex];
  if(annotations[fname] && annotations[fname][labels[currentLabelIndex]]){
    delete annotations[fname][labels[currentLabelIndex]];
    logStatus(`Erased point "${labels[currentLabelIndex]}" on ${fname}`);
    redrawPoints();
  } else logStatus(`No point to erase for "${labels[currentLabelIndex]}"`);
}

function clearCurrentLabel(){
  const fname = currentFiles[currentImageIndex];
  if(annotations[fname]) { delete annotations[fname]; redrawPoints(); }
}

/* ---------- CSV ---------- */
function downloadCSV(){
  const files = speciesData[currentSpecies].files;
  let csv="scorer,,"+labels.join(",,")+"\ncoords,,"+labels.map(()=> "x,y").join(",")+"\n";
  files.forEach(f=>{
    csv+="labeled-data,,"+f+",";
    const pts=annotations[f]||{};
    labels.forEach(l=>{
      if(pts[l]) csv+=pts[l].x+","+pts[l].y+","; else csv+="NaN,NaN,";
    });
    csv+="\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=currentSpecies.replace(/\s+/g,"_")+"_"+randomID+"_annotations.csv";
  a.click();
  annotations.downloaded = true;
  logStatus("CSV downloaded for " + currentSpecies);
}

/* ---------- Species switching ---------- */
speciesSelect.addEventListener("change", ()=>{
  const newSpecies = speciesSelect.value;
  if(Object.keys(annotations).length > 0 && !annotations.downloaded){
    const proceed = confirm(
      `âš  You have unsaved annotations for ${currentSpecies}.\n\nPlease download your CSV before switching.\n\nClick OK to discard and continue, or Cancel to stay.`
    );
    if(!proceed){
      speciesSelect.value = currentSpecies;
      return;
    }
  }
  // Save current annotations
  annotationsBySpecies[currentSpecies] = annotations;

  // Switch species
  currentSpecies = newSpecies;
  currentFiles = speciesData[newSpecies].files;
  annotations = annotationsBySpecies[newSpecies] || {};
  currentImageIndex = 0;
  currentLabelIndex = 0;
  setLabelInfo();
  loadImage();
});

/* ---------- Init ---------- */
setLabelInfo();
loadImage();
</script>
</body>
</html>

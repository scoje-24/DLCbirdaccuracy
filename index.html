<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Point Labeler â€” With Random ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; text-align: center; margin: 8px; }
    #canvasWrap { display:inline-block; border:2px solid #333; padding:6px; background:#fafafa; max-width:95vw; }
    canvas { display:block; cursor:crosshair; max-width:100%; height:auto; }
    #controls { margin:12px 0; }
    #labelInfo { font-size:16px; font-weight:600; margin-top:8px; }
    #status { font-size:13px; color:#555; margin-top:6px; white-space:pre-wrap; text-align:left; max-width:95vw; margin:0 auto; }
    button { margin: 4px; padding:8px 12px; }
  </style>
</head>
<body>
  <h2>Point Labeler</h2>

  <div id="canvasWrap">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <div id="labelInfo"></div>

  <div id="controls">
    <button onclick="prevImage()">â¬… Prev Image</button>
    <button onclick="prevLabel()">âŸ² Prev Label</button>
    <button onclick="nextLabel()">Next Label âŸ³</button>
    <button onclick="nextImage()">Next Image âž¡</button>
    <button onclick="clearCurrentLabel()">âœ– Clear All Labels (this image)</button>
    <button onclick="eraseCurrentPoint()">ðŸ©¹ Erase Current Point</button>
    <button onclick="downloadCSV()">â¬‡ Download CSV</button>
  </div>

  <div id="status">Status will appear here...</div>

<script>
/* ---------- Config ---------- */
const labels = ["topBeaktip","botBeaktip","rightEye","rightHinge","leftEye","leftHinge"];
const colors = ["#e11","#1177ee","#129912","#c71585","#f39a1c","#00a5a5"];
const filenames = ["img0012.png","img0032.png","img0138.png"]; // shorten for demo
const folderCandidates = ["savannah sparrow/","savannah_sparrow/"];

/* ---------- State ---------- */
let currentImageIndex = 0;
let currentLabelIndex = 0;
const annotations = {}; // { filename: { label: {x,y} } }

// ðŸ”¹ Generate random 10-digit ID once per session
const randomID = Math.floor(1000000000 + Math.random() * 9000000000).toString();

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const img = new Image();
const statusEl = document.getElementById("status");
const labelInfoEl = document.getElementById("labelInfo");

/* ---------- Helpers ---------- */
function logStatus(txt) {
  console.log(txt);
  statusEl.textContent = txt;
}
function setLabelInfo() {
  labelInfoEl.textContent = `Label: ${labels[currentLabelIndex]}  |  Image ${currentImageIndex+1}/${filenames.length} (${filenames[currentImageIndex]})`;
}

/* ---------- Image loading ---------- */
function loadImage() {
  const baseName = filenames[currentImageIndex];
  let tried = 0;
  function tryNextFolder() {
    if (tried >= folderCandidates.length) {
      drawPlaceholder(`Missing: ${baseName}`);
      logStatus(`Failed to load ${baseName}`);
      return;
    }
    const folder = folderCandidates[tried++];
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img,0,0);
      redrawPoints();
      setLabelInfo();
      logStatus(`Loaded: ${folder}${baseName}`);
    };
    img.onerror = tryNextFolder;
    img.src = encodeURI(folder + baseName);
  }
  tryNextFolder();
}
function drawPlaceholder(text) {
  const w = 800, h = 500;
  canvas.width = w; canvas.height = h;
  ctx.fillStyle="#eee"; ctx.fillRect(0,0,w,h);
  ctx.fillStyle="#333"; ctx.font="20px Arial"; ctx.fillText(text,20,40);
}

/* ---------- Canvas interaction ---------- */
function clientToImageCoords(x,y) {
  const rect = canvas.getBoundingClientRect();
  return {
    x:(x-rect.left)*(canvas.width/rect.width),
    y:(y-rect.top)*(canvas.height/rect.height)
  };
}
canvas.addEventListener("click",(e)=>{
  if(!img.complete) return;
  const {x,y} = clientToImageCoords(e.clientX,e.clientY);
  const fname = filenames[currentImageIndex];
  if(!annotations[fname]) annotations[fname]={};
  annotations[fname][labels[currentLabelIndex]]={x:+x.toFixed(2),y:+y.toFixed(2)};
  redrawPoints();
});

/* ---------- Redraw ---------- */
function redrawPoints() {
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const fname = filenames[currentImageIndex];
  const pts = annotations[fname]||{};
  labels.forEach((lab,i)=>{
    if(pts[lab]) {
      ctx.fillStyle=colors[i];
      ctx.beginPath(); ctx.arc(pts[lab].x,pts[lab].y,6,0,2*Math.PI); ctx.fill();
      ctx.fillText(lab,pts[lab].x+8,pts[lab].y-8);
    }
  });
}

/* ---------- Navigation ---------- */
function nextLabel(){ currentLabelIndex=(currentLabelIndex+1)%labels.length; setLabelInfo();}
function prevLabel(){ currentLabelIndex=(currentLabelIndex-1+labels.length)%labels.length; setLabelInfo();}
function nextImage(){ if(currentImageIndex<filenames.length-1){currentImageIndex++; loadImage();} }
function prevImage(){ if(currentImageIndex>0){currentImageIndex--; loadImage();} }

/* ---------- Erasers ---------- */
function eraseCurrentPoint() {
  const fname = filenames[currentImageIndex];
  if(annotations[fname] && annotations[fname][labels[currentLabelIndex]]) {
    delete annotations[fname][labels[currentLabelIndex]];
    logStatus(`Erased point "${labels[currentLabelIndex]}" on ${fname}`);
    redrawPoints();
  } else {
    logStatus(`No point to erase for "${labels[currentLabelIndex]}"`);
  }
}
function clearCurrentLabel() {
  const fname = filenames[currentImageIndex];
  if(annotations[fname]) { delete annotations[fname]; redrawPoints(); }
}

/* ---------- CSV ---------- */
function downloadCSV() {
  let csv="scorer,,"+labels.join(",,")+"\ncoords,,"+labels.map(()=> "x,y").join(",")+"\n";
  filenames.forEach(f=>{
    csv+="labeled-data,,"+f+",";
    const pts=annotations[f]||{};
    labels.forEach(l=>{
      if(pts[l]) csv+=pts[l].x+","+pts[l].y+",";
      else csv+="NaN,NaN,";
    });
    csv+="\n";
  });
  const blob=new Blob([csv],{type:"text/csv"}), url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=randomID+"_annotations.csv";  // ðŸ”¹ Use random ID
  a.click();
}

/* ---------- Init ---------- */
setLabelInfo(); loadImage();
</script>
</body>
</html>

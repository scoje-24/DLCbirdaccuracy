<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Point Labeler â€” With Random ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; text-align: center; margin: 8px; }
    #canvasWrap { display:inline-block; border:2px solid #333; padding:6px; background:#fafafa; max-width:95vw; }
    canvas { display:block; cursor:crosshair; max-width:100%; height:auto; }
    #controls { margin:12px 0; }
    #labelInfo { font-size:16px; font-weight:600; margin-top:8px; }
    #status { font-size:13px; color:#555; margin-top:6px; white-space:pre-wrap; text-align:left; max-width:95vw; margin:0 auto; }
    #instructions { 
      max-width: 800px; 
      margin: 20px auto; 
      text-align: left; 
      font-size: 15px; 
      line-height: 1.5; 
      background: #f9f9f9; 
      padding: 12px 16px; 
      border-radius: 8px; 
      border: 1px solid #ddd;
    }
    button { margin: 4px; padding:8px 12px; }
  </style>
</head>
<body>
  <h2>Point Labeler</h2>

  <div id="canvasWrap">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <div id="labelInfo"></div>

  <div id="controls">
    <button onclick="prevImage()">â¬… Prev Image</button>
    <button onclick="prevLabel()">âŸ² Prev Label</button>
    <button onclick="nextLabel()">Next Label âŸ³</button>
    <button onclick="nextImage()">Next Image âž¡</button>
    <button onclick="clearCurrentLabel()">âœ– Clear All Labels (this image)</button>
    <button onclick="eraseCurrentPoint()">ðŸ©¹ Erase Current Point</button>
    <button onclick="downloadCSV()">â¬‡ Download CSV</button>
  </div>

  <div id="status">Status will appear here...</div>

  <!-- ðŸ”¹ Instructions section -->
  <div id="instructions">
    <p><strong>Hello!</strong> Thank you for being willing to take part in this project. The data from the points you place will be used to confirm if a machine learning model is able to approximate human labelling accuracy. Even if you are not able to get through all of the provided images, any data will help and is appreciated!</p>

    <p>There are 6 potential points to place on each image:</p>
    <ul>
      <li><strong>"topBeaktip"</strong>: the pointed tip of the top beak (dark blue)</li>
      <li><strong>"botBeaktip"</strong>: the pointed tip of the bottom beak (white)</li>
      <li><strong>"rightHinge"</strong>: where the two halves of the beak meet on the right side (right side = birdâ€™s right = your left, i.e. bird is facing right) (aqua)</li>
      <li><strong>"leftHinge"</strong>: where the two halves of the beak meet on the left side (left side = birdâ€™s left = your right, i.e. bird is facing left) (not shown)</li>
      <li><strong>"leftEye"</strong>: center of the left eye (left side = birdâ€™s left = your right)(not shown)</li>
      <li><strong>"rightEye"</strong>: center of the right eye (right side = birdâ€™s right = your left) (pink)</li>
    </ul>

    <p>Examples of the points are provided below. If one or more of these locations is not visible on your image, please do not place that point on the image.</p>

    <p>When you have labelled all of the images, click <strong>"Download CSV"</strong> and email the generated CSV to me at:  
    <a href="mailto:jscot24@ilstu.edu">jscot24@ilstu.edu</a> with the subject line "DeepLabCut data"</p>
  </div>
  <div style="margin-top: 20px; text-align: center;">
  <img src="closedbeakEx.JPG" alt="Closed beak example" style="max-width: 500px; width: 100%; margin-bottom: 15px;">
  <img src="openbeakex.JPG" alt="Open beak example" style="max-width: 500px; width: 100%;">
</div>


<script>
/* ---------- Config ---------- */
const labels = ["topBeaktip","botBeaktip","rightEye","rightHinge","leftEye","leftHinge"];
const colors = ["#e11","#1177ee","#129912","#c71585","#f39a1c","#00a5a5"];
const filenames = ["img0012.png","img0032.png","img0138.png","img0254.png","img0260.png","img0273.png","img0381.png","img0433.png",
 "img0457.png","img0566.png","img0651.png","img0925.png","img1055.png","img1129.png","img1154.png","img1184.png",
 "img1272.png","img1284.png","img1409.png","img1465.png","img1477.png","img1480.png","img1553.png","img1678.png",
 "img1748.png","img1804.png","img1854.png","img2006.png","img2064.png","img2067.png","img2146.png","img2224.png",
 "img2257.png","img2283.png","img2302.png","img2396.png","img2424.png","img2440.png","img2562.png","img2624.png",
 "img2691.png","img2730.png","img2876.png","img2978.png","img3041.png","img3089.png","img3101.png","img3124.png",
 "img3181.png","img3277.png","img3306.png","img3309.png","img3340.png","img3353.png","img3360.png","img3433.png",
 "img3467.png","img3537.png","img3554.png","img3584.png","img3695.png","img3732.png","img3783.png","img3862.png",
 "img3880.png","img3894.png","img3905.png","img3983.png","img3999.png","img4190.png","img4210.png","img4280.png",
 "img4421.png","img4433.png","img4452.png","img4540.png","img4630.png","img4711.png","img4781.png","img4872.png",
 "img4876.png","img4902.png","img4940.png","img4962.png","img4992.png","img5000.png","img5007.png","img5015.png",
 "img5064.png","img5076.png","img5108.png","img5112.png","img5305.png","img5325.png","img5423.png","img5448.png",
 "img5508.png"]; // shorten for demo
const folderCandidates = ["savannah sparrow/","savannah_sparrow/"];

/* ---------- State ---------- */
let currentImageIndex = 0;
let currentLabelIndex = 0;
const annotations = {}; // { filename: { label: {x,y} } }

// ðŸ”¹ Generate random 10-digit ID once per session
const randomID = Math.floor(1000000000 + Math.random() * 9000000000).toString();

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const img = new Image();
const statusEl = document.getElementById("status");
const labelInfoEl = document.getElementById("labelInfo");

/* ---------- Helpers ---------- */
function logStatus(txt) {
  console.log(txt);
  statusEl.textContent = txt;
}
function setLabelInfo() {
  labelInfoEl.textContent = `Label: ${labels[currentLabelIndex]}  |  Image ${currentImageIndex+1}/${filenames.length} (${filenames[currentImageIndex]})`;
}

/* ---------- Image loading ---------- */
function loadImage() {
  const baseName = filenames[currentImageIndex];
  let tried = 0;
  function tryNextFolder() {
    if (tried >= folderCandidates.length) {
      drawPlaceholder(`Missing: ${baseName}`);
      logStatus(`Failed to load ${baseName}`);
      return;
    }
    const folder = folderCandidates[tried++];
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img,0,0);
      redrawPoints();
      setLabelInfo();
      logStatus(`Loaded: ${folder}${baseName}`);
    };
    img.onerror = tryNextFolder;
    img.src = encodeURI(folder + baseName);
  }
  tryNextFolder();
}
function drawPlaceholder(text) {
  const w = 800, h = 500;
  canvas.width = w; canvas.height = h;
  ctx.fillStyle="#eee"; ctx.fillRect(0,0,w,h);
  ctx.fillStyle="#333"; ctx.font="20px Arial"; ctx.fillText(text,20,40);
}

/* ---------- Canvas interaction ---------- */
function clientToImageCoords(x,y) {
  const rect = canvas.getBoundingClientRect();
  return {
    x:(x-rect.left)*(canvas.width/rect.width),
    y:(y-rect.top)*(canvas.height/rect.height)
  };
}
canvas.addEventListener("click",(e)=>{
  if(!img.complete) return;
  const {x,y} = clientToImageCoords(e.clientX,e.clientY);
  const fname = filenames[currentImageIndex];
  if(!annotations[fname]) annotations[fname]={};
  annotations[fname][labels[currentLabelIndex]]={x:+x.toFixed(2),y:+y.toFixed(2)};
  redrawPoints();
});

/* ---------- Redraw ---------- */
function redrawPoints() {
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const fname = filenames[currentImageIndex];
  const pts = annotations[fname]||{};
  labels.forEach((lab,i)=>{
    if(pts[lab]) {
      ctx.fillStyle=colors[i];
      ctx.beginPath(); ctx.arc(pts[lab].x,pts[lab].y,6,0,2*Math.PI); ctx.fill();
      ctx.fillText(lab,pts[lab].x+8,pts[lab].y-8);
    }
  });
}

/* ---------- Navigation ---------- */
function nextLabel(){ currentLabelIndex=(currentLabelIndex+1)%labels.length; setLabelInfo();}
function prevLabel(){ currentLabelIndex=(currentLabelIndex-1+labels.length)%labels.length; setLabelInfo();}
function nextImage(){ if(currentImageIndex<filenames.length-1){currentImageIndex++; loadImage();} }
function prevImage(){ if(currentImageIndex>0){currentImageIndex--; loadImage();} }

/* ---------- Erasers ---------- */
function eraseCurrentPoint() {
  const fname = filenames[currentImageIndex];
  if(annotations[fname] && annotations[fname][labels[currentLabelIndex]]) {
    delete annotations[fname][labels[currentLabelIndex]];
    logStatus(`Erased point "${labels[currentLabelIndex]}" on ${fname}`);
    redrawPoints();
  } else {
    logStatus(`No point to erase for "${labels[currentLabelIndex]}"`);
  }
}
function clearCurrentLabel() {
  const fname = filenames[currentImageIndex];
  if(annotations[fname]) { delete annotations[fname]; redrawPoints(); }
}

/* ---------- CSV ---------- */
function downloadCSV() {
  let csv="scorer,,"+labels.join(",,")+"\ncoords,,"+labels.map(()=> "x,y").join(",")+"\n";
  filenames.forEach(f=>{
    csv+="labeled-data,,"+f+",";
    const pts=annotations[f]||{};
    labels.forEach(l=>{
      if(pts[l]) csv+=pts[l].x+","+pts[l].y+",";
      else csv+="NaN,NaN,";
    });
    csv+="\n";
  });
  const blob=new Blob([csv],{type:"text/csv"}), url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=randomID+"_annotations.csv";  // ðŸ”¹ Use random ID
  a.click();
}

/* ---------- Init ---------- */
setLabelInfo(); loadImage();
</script>
</body>
</html>
